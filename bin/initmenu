#!/bin/bash

RED='\e[41m'
BLUE='\e[44m'
ORANGE='\e[46m'
NC='\e[0m'
STATUSVAR=0
TEXTEDITOR=$EDITOR

# Service messages section
CONTINMSG="$BLUE Press any key to continue$NC"
ERRORMSG="$RED Wrong option $NC"
TRYAGAINMSG="Press any key and try again"
SELECTFILEMSG="Select file to configure and press Enter: "
SELECTTARGETMSG="Select target and press Enter to change to: "
SERVICEPREFIXMSG="Service "
SERVICESTARTEDMSG=" was started successfully"
SERVICEENABLEDMSG=" was enabled successfully"
SERVICESTOPPEDMSG=" was stopped successfully"
SERVICEDISABLEDMSG=" was disabled successfully"
STARTTIMEMSG="$ORANGE      Start time$NC"
BOOTSERVICEMSG="$ORANGE Boot service$NC"

function config_editor {
PS3="$SELECTFILEMSG"
configs=("journald.conf" "system.conf" "logind.conf" "user.conf" "cancel")

select pick in "${configs[@]}"
do
	case $pick in
		logind.conf)
			sudo $TEXTEDITOR /etc/systemd/logind.conf 
			break
			;;		
		system.conf)
			sudo $TEXTEDITOR /etc/systemd/system.conf
			break
			;;		
		journald.conf)
			sudo $TEXTEDITOR /etc/systemd/journald.conf
			break
			;;		
		user.conf)
			sudo $TEXTEDITOR /etc/systemd/user.conf
			break
			;;		
		cancel)
			break
	esac
done
	
}

function change_runlevel {
PS3="$SELECTTARGETMSG"
targets=("poweroff" "rescue" "multi-user" "graphical" "reboot" "cancel")

select pick in "${targets[@]}"
do
	case $pick in
		poweroff)
			sudo systemctl isolate poweroff.target
			break
			;;		
		reboot)
			sudo systemctl isolate reboot.target
			break
			;;		
		rescue)
			sudo systemctl isolate rescue.target
			break
			;;		
		multi-user)
			sudo systemctl isolate multi-user.target
			break
			;;		
		graphical)
			sudo systemctl isolate graphical.target
			break
			;;		
		cancel)
			break
	esac
done
	
	
}

function enable_services {
	OUTPUTITEM=""
	OUTPUTITEM=$(systemctl list-unit-files | awk '/disabled/ {print $1}' | fzf -m -e --reverse)
	if [ "$OUTPUTITEM" != "" ]
	then
		sudo systemctl enable $OUTPUTITEM
		STATUSVAR=$?
	else
		STATUSVAR=1
	fi
}

function start_services {
	OUTPUTITEM=""
	OUTPUTITEM=$(systemctl list-unit-files | awk '/disabled/ {print $1}' | fzf -m -e --reverse)
	if [ "$OUTPUTITEM" != "" ]
	then
		sudo systemctl start $OUTPUTITEM
		STATUSVAR=$?
	else
		STATUSVAR=1
	fi
}

function stop_services {
	OUTPUTITEM=""
	OUTPUTITEM=$(systemctl list-unit-files | awk '/enabled/ {print $1}' | fzf -m -e --reverse)
	if [ "$OUTPUTITEM" != "" ]
	then
		sudo systemctl stop $OUTPUTITEM
		STATUSVAR=$?
	else
		STATUSVAR=1
	fi
}

function disable_services {
	OUTPUTITEM=""
	OUTPUTITEM=$(systemctl list-unit-files | awk '/enabled/ {print $1}' | fzf -m -e --reverse)
	if [ "$OUTPUTITEM" != "" ]
	then
		sudo systemctl disable $OUTPUTITEM
		STATUSVAR=$?
	else
		STATUSVAR=1
	fi

}

    while true; do
    clear
    echo ""
    echo -e "                          ::Init menu:: "
    echo -e " ┌─────────────────────────────────────────────────────────────┐"
    echo -e " │    1   Enable services              2   Disable services    │"
    echo -e " │    3   Start services               4   Stop Services       │"
    echo -e " │    5   List active services         6   Show boot messages  │"    
    echo -e " │    7   Edit configuration files     8   Change runlevel     │"
    echo -e " │    9   Analyze boot                                         │"
    echo -e " └─────────────────────────────────────────────────────────────┘"
    echo -e "          Select an item       -       0   Exit "
    echo ""
    read -s -n1 choix
    case $choix in
        1)
            echo
            enable_services
	    if [ $STATUSVAR -eq 0 ]
	    then
		    echo -e "$SERVICEPREFIXMSG$OUTPUTITEM$SERVICEENABLEDMSG"
		    echo -e "$CONTINMSG"
		    read -s -n1
	    else
		    echo ""
	    fi
	    STATUSVAR=0
            ;;
        2)
            echo
            disable_services
	    if [ $STATUSVAR -eq 0 ]
	    then
		    echo -e "$SERVICEPREFIXMSG$OUTPUTITEM$SERVICEDISABLEDMSG"
		    echo -e "$CONTINMSG"
		    read -s -n1
	    else
		    echo ""
	    fi
	    STATUSVAR=0
            ;;
        3)
            echo
            start_services
	    if [ $STATUSVAR -eq 0 ]
	    then
		    echo -e "$SERVICEPREFIXMSG$OUTPUTITEM$SERVICESTARTEDMSG"
		    echo -e "$CONTINMSG"
		    read -s -n1
	    else
		    echo""
	    fi
	    STATUSVAR=0
            ;;
        4)
            echo
            stop_services
	    if [ $STATUSVAR -eq 0 ]
	    then
		    echo -e "$SERVICEPREFIXMSG$OUTPUTITEM$SERVICESTOPPEDMSG"
		    echo -e "$CONTINMSG"
		    read -s -n1
	    else
		    echo ""
	    fi
	    STATUSVAR=0
	    ;;
        5)
            echo
            systemctl
            echo ""
            echo -e "$CONTINMSG"
            read -s -n1
            ;;
        6)
            echo
            dmesg
            echo ""
            echo -e "$CONTINMSG"
            read -s -n1
            ;;
        7)
            echo
            config_editor
            echo ""
            ;;
        8)
            echo
            change_runlevel
            echo ""
            ;;
        9)
            echo
	    clear
	    echo -e "$STARTTIMEMSG$BOOTSERVICEMSG"
            systemd-analyze blame
            echo ""
            echo -e "$CONTINMSG"
            read -s -n1
            ;;
        0)
            clear && exit
            ;;
        *)
            echo -e "$ERRORMSG"
	    echo -e "$TRYAGAINMSG"
            read -s -n1
            clear
            ;;
    esac
    done
fi
